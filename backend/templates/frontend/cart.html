{% extends "frontend/base.html" %}
{% load static %}
{% block title %}Cart | MyShop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}

<h2 class="cart-title">Your Shopping Cart</h2>

<div class="cart-container">
    <table class="cart-table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Image</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="cart-summary">
        <h3>Total: ₹<span id="cart-total">0.00</span></h3>
        <button id="checkout-button">Proceed to Checkout</button>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>

<script>
/* --------------------------
    RENDER CART
--------------------------- */
function renderCart() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const tbody = document.querySelector('.cart-table tbody');
    tbody.innerHTML = '';

    let total = 0;

    cart.forEach((item, index) => {
        const subtotal = item.price * item.quantity;
        total += subtotal;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.title}</td>
            <td>
                <img src="${item.image}" alt="${item.title}" width="80" height="80">
            </td>
            <td>₹${item.price.toFixed(2)}</td>
            <td>
                <input type="number" min="1" value="${item.quantity}"
                    data-index="${index}" class="qty-input">
            </td>
            <td>₹${subtotal.toFixed(2)}</td>
            <td>
                <button class="remove-btn" data-index="${index}">Remove</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    document.getElementById('cart-total').textContent = total.toFixed(2);
}

/* --------------------------
    UPDATE QUANTITY
--------------------------- */
document.addEventListener('input', e => {
    if (e.target.classList.contains('qty-input')) {
        const index = e.target.dataset.index;
        const qty = parseInt(e.target.value);

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart[index].quantity = qty;
        localStorage.setItem('cart', JSON.stringify(cart));

        renderCart();
    }
});

/* --------------------------
    REMOVE ITEM
--------------------------- */
document.addEventListener('click', e => {
    if (e.target.classList.contains('remove-btn')) {
        const index = e.target.dataset.index;

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));

        renderCart();
    }
});

/* --------------------------
    STRIPE CHECKOUT
--------------------------- */
document.getElementById('checkout-button').addEventListener('click', async () => {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (cart.length === 0) return alert("Your cart is empty!");

    try {
        const response = await fetch('/api/create-checkout-session/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cart })
        });

        const data = await response.json();

        if (data.id) {
            const stripe = Stripe('{{ stripe_public_key }}');
            await stripe.redirectToCheckout({ sessionId: data.id });
        } else {
            console.error(data);
            alert("Error creating checkout session.");
        }
    } catch (err) {
        console.error(err);
        alert("Payment failed.");
    }
});

/* --------------------------
    INIT
--------------------------- */
renderCart();
</script>

{% endblock %}
