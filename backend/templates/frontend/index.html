{% extends "frontend/base.html" %}
{% load static %}
{% block title %}Home | MyShop{% endblock %}

{% block content %}
<h2 class="section-title">Featured Products</h2>

<div class="product-grid">
    {% for product in products %}
    <div class="product-card">
        
        {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.title }}">
        {% else %}
            <img src="{% static 'images/no-image.png' %}" alt="No image">
        {% endif %}

        <h3>{{ product.title }}</h3>
        <p class="price">₹{{ product.price }}</p>

        <div class="btn-group">
            <button class="add-to-cart-btn"
                data-id="{{ product.id }}"
                data-title="{{ product.title }}"
                data-price="{{ product.price }}"
                data-image="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}">
                Add to Cart
            </button>

            <button class="buy-now-btn"
                data-id="{{ product.id }}"
                data-title="{{ product.title }}"
                data-price="{{ product.price }}"
                data-image="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}">
                Buy Now
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://js.stripe.com/v3/"></script>

<script>
/* ------------------------------
   CART BADGE COUNTER
------------------------------ */
function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    document.getElementById('cart-count').textContent =
        cart.reduce((a, b) => a + b.quantity, 0);
}

/* ------------------------------
   ADD TO CART
------------------------------ */
document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', () => {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        const product = {
            id: parseInt(button.dataset.id),
            title: button.dataset.title,
            price: parseFloat(button.dataset.price),
            quantity: 1,
            image: button.dataset.image
        };

        const existing = cart.find(item => item.id === product.id);
        if (existing) existing.quantity++;
        else cart.push(product);

        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        alert(`${product.title} added to cart!`);
    });
});

/* ------------------------------
   BUY NOW → immediate checkout
------------------------------ */
document.querySelectorAll('.buy-now-btn').forEach(button => {
    button.addEventListener('click', async () => {
        const product = {
            id: parseInt(button.dataset.id),
            title: button.dataset.title,
            price: parseFloat(button.dataset.price),
            quantity: 1,
            image: button.dataset.image
        };

        // Store only this item for checkout
        localStorage.setItem('cart', JSON.stringify([product]));
        updateCartCount();

        try {
            const response = await fetch('/api/create-checkout-session/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: [product] })
            });

            const data = await response.json();
            if (data.id) {
                const stripe = Stripe('{{ stripe_public_key }}');
                await stripe.redirectToCheckout({ sessionId: data.id });
            } else {
                console.error(data);
                alert('Stripe error: ' + (data.error || 'Checkout failed'));
            }
        } catch (error) {
            console.error(error);
            alert('Server error! Check console.');
        }
    });
});

/* ------------------------------
   INIT
------------------------------ */
updateCartCount();
</script>

{% endblock %}
